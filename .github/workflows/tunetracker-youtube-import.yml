name: TuneTracker YouTube Import

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: "TuneTracker import job id"
        required: true
      entry_id:
        description: "TuneTracker entry id"
        required: true
      youtube_url:
        description: "YouTube URL to import"
        required: true
      callback_url:
        description: "App callback URL"
        required: true

jobs:
  import-audio:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup yt-dlp and ffmpeg
        uses: AnimMouse/setup-yt-dlp@v3
        with:
          ffmpeg: true

      - name: Send processing callback
        env:
          CALLBACK_SECRET: ${{ secrets.TUNETRACKER_IMPORT_CALLBACK_SECRET }}
          CALLBACK_URL: ${{ inputs.callback_url }}
          JOB_ID: ${{ inputs.job_id }}
        run: |
          payload=$(jq -cn --arg jobId "$JOB_ID" --arg status "processing" '{jobId:$jobId,status:$status}')
          signature=$(printf "%s" "$payload" | openssl dgst -sha256 -hmac "$CALLBACK_SECRET" | awk '{print $2}')

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-tunetracker-signature: $signature" \
            --data "$payload"

      - name: Download, convert, and upload to R2
        id: import_audio
        env:
          YOUTUBE_URL: ${{ inputs.youtube_url }}
          ENTRY_ID: ${{ inputs.entry_id }}
          JOB_ID: ${{ inputs.job_id }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          set -euo pipefail

          VIDEO_ID=$(yt-dlp --get-id "$YOUTUBE_URL" | head -n 1)
          if [ -z "$VIDEO_ID" ]; then
            echo "Failed to resolve video id"
            exit 1
          fi

          yt-dlp \
            --extract-audio \
            --audio-format mp3 \
            --audio-quality 0 \
            --output "${VIDEO_ID}.%(ext)s" \
            "$YOUTUBE_URL"

          AUDIO_FILE="${VIDEO_ID}.mp3"
          if [ ! -f "$AUDIO_FILE" ]; then
            echo "Expected output file not found: $AUDIO_FILE"
            exit 1
          fi

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          AUDIO_KEY="tune-tracker/imported/${ENTRY_ID}/${JOB_ID}.mp3"

          aws s3 cp "$AUDIO_FILE" "s3://${R2_BUCKET}/${AUDIO_KEY}" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "audio/mpeg"

          echo "audio_key=$AUDIO_KEY" >> "$GITHUB_OUTPUT"

      - name: Send completed callback
        if: success()
        env:
          CALLBACK_SECRET: ${{ secrets.TUNETRACKER_IMPORT_CALLBACK_SECRET }}
          CALLBACK_URL: ${{ inputs.callback_url }}
          JOB_ID: ${{ inputs.job_id }}
          AUDIO_KEY: ${{ steps.import_audio.outputs.audio_key }}
        run: |
          payload=$(jq -cn --arg jobId "$JOB_ID" --arg status "completed" --arg audioKey "$AUDIO_KEY" '{jobId:$jobId,status:$status,audioKey:$audioKey}')
          signature=$(printf "%s" "$payload" | openssl dgst -sha256 -hmac "$CALLBACK_SECRET" | awk '{print $2}')

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-tunetracker-signature: $signature" \
            --data "$payload"

      - name: Send failed callback
        if: failure()
        env:
          CALLBACK_SECRET: ${{ secrets.TUNETRACKER_IMPORT_CALLBACK_SECRET }}
          CALLBACK_URL: ${{ inputs.callback_url }}
          JOB_ID: ${{ inputs.job_id }}
        run: |
          payload=$(jq -cn --arg jobId "$JOB_ID" --arg status "failed" --arg error "GitHub Actions import failed" '{jobId:$jobId,status:$status,error:$error}')
          signature=$(printf "%s" "$payload" | openssl dgst -sha256 -hmac "$CALLBACK_SECRET" | awk '{print $2}')

          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "x-tunetracker-signature: $signature" \
            --data "$payload"
